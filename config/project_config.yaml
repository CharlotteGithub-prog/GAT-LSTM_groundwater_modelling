# ==============================================================================
# GLOBAL CONFIG SETTINGS
# ==============================================================================
global:
  pipeline_settings:
    project_name: "Catchment_Based_Groundwater_Forecasting"
    random_seed: 55  # Smooth operation
    log_level: "INFO"  # DEBUG, INFO, WARNING, ERROR
    catchments_to_process: ["eden"]  # TODO: can easily add more in future dev
    run_defra_api: false
    run_camels_api: false
    run_era5_land_api: false  # Long!
    run_outlier_detection: false
    run_gwl_imputation: false
    prediction_resolution: "daily"  # Options: ["daily", "weekly", "monthly"]
    output_resolution: "weekly"  # Must be equal to or higher than prediction_resolution

  # --- FILE PATHS ---
  paths:
    raw_data_root: "../msc-groundwater-gwl-data"  # Alternative: "data"
    results_root: "../msc-groundwater-gwl-parallel-results"  # Alternative: "results"
    # --- Specific INPUT files ---
    gis_os_grid_squares: "{raw_data_root}/01_raw/global/os_grid_squares.csv"
    defra_station_base_url: "https://environment.data.gov.uk/hydrology/id/stations"
    HAD_UK_rainfall_url: "https://dap.ceda.ac.uk/thredds/dodsC/badc/ukmo-hadobs/data/insitu/MOHC/HadOBS/HadUK-Grid/v1.3.0.ceda/1km/rainfall/day/v20240514/rainfall_hadukgrid_uk_1km_day_"
    CDSAPI_path: ".cdsapirc"
    # --- Specific OUTPUT files ---
      # currently none, remove in future if not used
    # --- Data Directories ---
    data_dir: "{raw_data_root}/"
    raw_data_dir: "{raw_data_root}/01_raw/"
    processed_data_dir: "{raw_data_root}/02_processed/"
    external_data_dir: "{raw_data_root}/03_external/"
    # --- Results Directories ---
    results_dir: "{results_root}/"
    logs_results_dir: "{results_root}/logs/"
    temp_results_dir: "{results_root}/temp_plots/"
    tables_results_dir: "{results_root}/tables/"
    figures_results_dir: "{results_root}/figures/"
    trained_model_results_dir: "{results_root}/trained_models/"
    predictions_results_dir: "{results_root}/predictions/"

  # --- DATA INGESTION SETTINGS ---
  data_ingestion:
    api_start_date: "2013-10-01T00:00:00"
    api_end_date: "2025-02-28T23:59:59"
    model_start_date: "2014-01-01T00:00:00"
    model_end_date: "2024-12-31T23:59:59"
    test_start_date: "2014-01-01T00:00:00"
    test_end_date: "2019-12-31T23:59:59"
    col_order: ['station_name', 'date', 'dateTime', 'value', 'quality', 'measure']
    max_interp_length: 25

  # --- PROPROCESSING SETTINGS ---
  preprocessing:
    radius: 6371000.0
    gap_lengths_days: [30, 60, 90, 120, 150]
    max_imputation_threshold: 200
    min_data_points_around_gap: 5

  # --- VISUALISATION SETTINGS ---
  visualisations:
    maps:
      display_interactive_map: true
      esri: "https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}"
      esri_attr: "Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ"
      map_blue: "#354c7c"

  # --- GRAPH CONSTRUCTION SETTINGS ---
  graph:
    data_point_quantity_threshold: 5000
    graph_construction:
      graph_type: "grid_adjacency"  # Otherwise: "k_nearest_neighbors", "delaunay_triangulation", etc.
      k_neighbors: 8  # Basic Surrounding Grid
    sentinel_value: -999.0  # Float to match col dtypes
    epsilon: 1e-6

  # --- MODEL SETTINGS (for GAT-LSTM) ---
  model:
    data_loader_batch_size: 1  # Necessary due to LSTM portion
    data_loader_shuffle: false  # Essential for processing in temporal order
    architecture: "GAT_LSTM"
    gat_layers: 2
    gat_heads: 4
    lstm_hidden_dim: 128
    dropout_rate: 0.2
    output_dim: 1

  # # --- TRAINING SETTINGS ---
  # training:
  #   epochs: 100
  #   batch_size: 32
  #   learning_rate: 0.001
  #   optimizer: "Adam"
  #   loss_function: "MSELoss"
  #   early_stopping:
  #     patience: 10
  #     min_delta: 0.0001
  #   device: "cuda" # or "cpu"

  # # --- EVALUATION SETTINGS ---
  # evaluation:
  #   metrics: ["RMSE", "MAE", "R2"]
  #   save_plots: true
  #   split_ratio: 0.2 # 80% train, 20% test
  #   target_variable: "gwl_value" # Target Column: Groundwater Level

# ==============================================================================
# EDEN CATCHMENT CONFIG SETTINGS
# ==============================================================================

eden:
  target_mncat: "Eden and Esk"

  # --- FILE PATHS ---
  paths:
    # --- Specific INPUT files ---
    # gis_catchment_boundary: "{raw_data_root}/01_raw/eden/gis/eden_catchment_boundary/NRFA_catchments.shp"
    gis_catchment_boundary: "{raw_data_root}/01_raw/eden/gis/eden_catchment_boundary/WFD_Surface_Water_Operational_Catchments_Cycle_2.shp"
    gis_catchment_dir: "{raw_data_root}/01_raw/eden/gis/eden_catchment_boundary/"
    gwl_station_list: "{raw_data_root}/01_raw/eden/gwl_stations/station_list.csv"
    raw_land_cover_path: "{raw_data_root}/01_raw/eden/static/land_cover/gb2023lcm1km_dominant_aggregate.tif"
    elevation_dir_path: "{raw_data_root}/01_raw/eden/static/elevation/"
    rainfall_filename_dir: "{raw_data_root}/01_raw/eden/hydroclimatic/rainfall/"

    # --- Specific OUPUT (processed) files ---
    mesh_nodes_output: "{raw_data_root}/02_processed/eden/gis_and_mesh/catchment_mesh_nodes"  # ensure no specific file extension
    gwl_station_list_with_coords: "{raw_data_root}/02_processed/eden/gwl_station_data/station_list_with_coords.csv"
    gwl_station_list_output: "{raw_data_root}/02_processed/eden/gwl_station_data/updated_station_list_with_coords.csv"
    gwl_station_metadata_measures: "{raw_data_root}/02_processed/eden/gwl_station_data/gwl_station_metadata_measures.csv"
    snapped_station_node_mapping: "{raw_data_root}/02_processed/eden/gwl_station_data/snapped_station_node_mapping.csv"
    gwl_data_output_dir: "{raw_data_root}/01_raw/eden/gwl_stations/API_data/"
    gwl_outlier_dict: "{raw_data_root}/02_processed/eden/gwl_station_data/dict_witout_outliers.pkl"
    trimmed_output_dir: "{raw_data_root}/02_processed/eden/gwl_timeseries/"
    land_cover_csv_path: "{raw_data_root}/02_processed/eden/static/land_cover/land_cover.csv"
    elevation_tif_path: "{raw_data_root}/02_processed/eden/static/elevation/elevation.tif"
    direction_edge_weights_path: "{raw_data_root}/02_processed/eden/static/slope/direction_edge_weights.csv"
    slope_path: "{raw_data_root}/02_processed/eden/static/slope/slope_magnitude_aspect.csv"
    aet_raw_output_dir: "{raw_data_root}/01_raw/eden/hydroclimatic/aet/"
    output_polygon_dir: "{raw_data_root}/02_processed/eden/gis/"
    elevation_geojson_path: "{raw_data_root}/02_processed/eden/static/elevation/elevation.geojson"
    geology_dir: "{raw_data_root}/01_raw/eden/static/geology/data"
    permeability_dir: "{raw_data_root}/01_raw/eden/static/permeability"
    geology_df: "{raw_data_root}/02_processed/eden/static/geology"
    productivity_dir: "{raw_data_root}/01_raw/eden/static/aquifer_productivity/hydrogeology625k/"
    productivity_csv_path: "{raw_data_root}/02_processed/eden/static/aquifer_productivity/"
    rivers_dir: "{raw_data_root}/01_raw/eden/static/rivers/data/"
    rivers_csv_path: "{raw_data_root}/02_processed/eden/static/distance_to_river/"
    sup_thickness_dir: "{raw_data_root}/01_raw/eden/static/superficial_thickness/advanced/astm_v5/astm_gb/"
    sup_thickness_csv_path: "{raw_data_root}/02_processed/eden/static/superficial_thickness/"
    soil_dir: "{raw_data_root}/01_raw/eden/static/soil_hydrology/dominant_class/"
    soil_csv_path: "{raw_data_root}/02_processed/eden/static/soil_hydrology/"
    soil_type_dir: "{raw_data_root}/01_raw/eden/static/soil_type/"
    soil_type_csv_path: "{raw_data_root}/02_processed/eden/static/soil_type/"
    stream_flow_csv: "{raw_data_root}/02_processed/eden/hydroclimatic/streamflow"  # {pred_frequency}_streamflow.csv
    stream_flow_station: "{raw_data_root}/01_raw/eden/hydroclimatic/streamflow/flow_stations_list.csv"

    # --- ERA5-Land API Ingestion ---
    aet_processed_output_dir: "{raw_data_root}/02_processed/eden/hydroclimatic/aet/"
    2t_raw_output_dir: "{raw_data_root}/01_raw/eden/hydroclimatic/2meter_temp/"
    2t_processed_output_dir: "{raw_data_root}/02_processed/eden/hydroclimatic/2meter_temp/"
    sp_raw_output_dir: "{raw_data_root}/01_raw/eden/hydroclimatic/surface_pressure/"
    sp_processed_output_dir: "{raw_data_root}/02_processed/eden/hydroclimatic/surface_pressure/"
    aet_csv_path: "{raw_data_root}/02_processed/eden/hydroclimatic/aet/"  # aet_{pred_frequency}_catchment_sum.csv
    aet_fig_path: "{results_root}/figures/eden/time_series/hydroclimatic/aet_timeseries.png"
    2t_csv_path: "{raw_data_root}/02_processed/eden/hydroclimatic/2meter_temp/"  # 2m_temp_{pred_frequency}_catchment_mean.csv
    2t_fig_path: "{results_root}/figures/eden/time_series/hydroclimatic/2m_temp_timeseries.png"
    sp_csv_path: "{raw_data_root}/02_processed/eden/hydroclimatic/surface_pressure/"  # surface_pressure_{pred_frequency}_catchment_mean.csv
    sp_fig_path: "{results_root}/figures/eden/time_series/hydroclimatic/surface_pressure_timeseries.png"

    # --- HAD-UK data ingestion ---
    rainfall_processed_output_dir: "{raw_data_root}/02_processed/eden/hydroclimatic/rainfall/"
    rainfall_fig_path: "{results_root}/figures/eden/time_series/hydroclimatic/rainfall_volume_timeseries.png"
    rainfall_csv_path: "{raw_data_root}/02_processed/eden/hydroclimatic/rainfall/"  # rainfall_{pred_frequency}_catchment_sum_log_transform.csv

    # --- Graph Paths ---
    final_df_path: "{raw_data_root}/02_processed/eden/final_df/"
    graph_data_output_dir: "{raw_data_root}/03_graph/eden/tensors/"
    pyg_object_path: "{raw_data_root}/03_graph/eden/PyG/all_timesteps_list.pt"
    scalers_dir: "{raw_data_root}/03_graph/eden/scalers/"

    # --- Model Paths ---
    best_model_path: "{raw_data_root}/04_model/eden/model/best_model.pt"
    model_dir: "{raw_data_root}/04_model/eden/model/"
    aux_dir: "{raw_data_root}/02_processed/eden/auxiliary/"

  # --- PREPROCESSING SETTINGS ---
  preprocessing:
    inclusion_threshold: 5000
    large_catchment_threshold_m: 50000
    dist_corr_score_k_decay: 0.05
    dist_corr_score_threshold: 0.3
    graph_construction:
      grid_resolution: 1000  # Could change to 500m grid in future for performance. Will require pipeline adjustments.
    catchment_max_elevation: 945.40  # mAOD from https://nrfa.ceh.ac.uk/data/station/spatial/76007
    catchment_min_elevation: 8.00  # mAOD from https://nrfa.ceh.ac.uk/data/station/spatial/76007
    # --- Generated in Pipeline ---
    rainfall_boxcox_lambda: 0.1701496697839992
    aet_boxcox_lambda: 0.4931417208883217
    mean_elevation_boxcox_lambda: 0.43791794465031564
    mean_slope_deg_boxcox_lambda: -0.24587351671403726
    distance_to_river_boxcox_lambda: 0.32372267347270717
    # streamflow_m3_s_boxcox_lambda: -0.19592529692363342
    streamflow_total_m3_boxcox_lambda: -0.19592529692363342

  # --- VISUALISATION OUTPUT SETTINGS ---
  visualisations:
    maps:  # ensure no specific file extensions here
      static_mesh_map_output: "{results_root}/figures/eden/maps/static_mesh_map"
      interactive_mesh_map_output: "{results_root}/figures/eden/maps/interactive_mesh_map"
      interactive_station_map_output: "{results_root}/figures/eden/maps/interactive_station_mesh_map"
      interactive_directional_map_output: "{results_root}/figures/eden/maps/interactive_directional_map"
    ts_plots:
      time_series_gwl_output: "{results_root}/figures/eden/time_series/"
      dpi_save: 300  # Always adjust to 300 for final output run
      extension: "svg"
    corr_dist_score_scatters: "{results_root}/figures/eden/scatter/"
    violin_plt_path: "{results_root}/figures/eden/other/standardised_violins.png"

  # --- GRAPH CONSTRUCTION SETTINGS ---
  model:
    architecture:
      # --- Components ---
      run_GAT: true  # Turn sections off for benchmarking and performance analysis (ablation studies)
      run_LSTM: true
      run_node_conditioner: true
      initialise_with_dipped: true

      # --- GAT ---
      heads_gat: 12
      dropout_gat: 0.4  # 40% dropped
      hidden_channels_gat: 64  # FROM 64
      out_channels_gat: 64
      num_layers_gat: 2

      # --- LSTM ---
      dropout_lstm: 0.1  # Only applies between stacked layers, not when num_layers_lstm = 1
      hidden_channels_lstm: 32
      num_layers_lstm: 1  # 1 for now, stack layers later if needed for performance
      tbptt_window: 7
      
      # --- Full Model ---
      output_dim: 1  # one station gwl prediction per timestep
      edge_dim: 5  # should match edge_features.append([ length ])
      adam_learning_rate: 0.001
      adam_weight_decay: 0.001  # 0.001  # 5e-4 is common initial weight decay val - (0) currenlty 0.0005 to 0.005 > 0.001
      lambda_smooth: 0.1  # Relative to main loss; Set to 0.0 for no smoothing [0.1]
      lambda_curve: 0.015  # Set to 0.0 for no curvature smoothing [0.02]
      lambda_res_smooth: 0.05

      # --- Feature Definitions ---
      # NOTE: in_channels, temporal_lstm_input_dim, and static_and_other_dynamic_features_dim
      # are calculated dynamically in model_building.py using temporal_features list:
      temporal_features:
      - rainfall_volume_m3
      - rainfall_lag_1
      - rainfall_lag_2
      - rainfall_lag_3
      - rainfall_lag_4
      - rainfall_lag_5
      - rainfall_lag_6
      - rainfall_lag_7
      - rolling_30
      - rolling_60
      - 2m_temp
      - aet_volume
      - surface_pressure
      - season_sin
      - season_cos

    data_partioning:
      test_station_shortlist: ["ainstable", "coupland", "scaleby"]  # Length ideally >= minimum station req count
      val_station_shortlist: ["castle_carrock", "skirwith", "great_musgrave"]  # Length ideally >= minimum station req count
      percentage_train: 77
      percentage_val: 15  # 2 stations for validating
      percentage_test: 8  # 1 station tested at a time
      len_train: 11
      len_val: 2
      len_test: 1

  # --- MODEL IMPLEMENTATION SETTINGS ---
  training:
    verbose: true  # Run logger to debug (increases computation)
    num_epochs: 250  # Start here, may need to increase depending on computation times
    early_stopping_patience: 35 # Early Stopping: Number of epochs to wait for improvement in validation loss before stopping training.
    lr_scheduler_factor: 0.5  # ReduceLROnPlateau: Factor by which the learning rate will be reduced. PREVIOUSLY: 0.5
    lr_scheduler_patience: 8  # Patience for ReduceLROnPlateau: Number of epochs with no improvement in validation
    min_lr: 0.000001  # Min learning rate bound (Generally recommended: 1e-6)
    loss_delta: 0.0001  # Minimum change in loss required to count as improvement
    gradient_clip_max_norm: 1.0  # Gradient Clipping Max Norm: Maximum norm of the gradients for gradient clipping (help prevent exploding grad.)
    loss: "MAE"  # Options: MSE, MAE

# ==============================================================================
# FUTURE CATCHMENT CONFIG SETTINGS
# ==============================================================================

# Copy eden structure for full pipeline and adapt. Most Important: Handle data inputs (some API, some require download)
